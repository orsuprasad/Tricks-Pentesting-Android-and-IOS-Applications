# Tricks Pentesting Android and IOS Applications

## Introduction
### Android Architecture
<img  height="650em" src="https://developer.android.com/static/guide/platform/images/android-stack_2x.png" />

### Components
Activities - show screens to the user and allow them to interact with those screens  
e.g.  
`am start -n <package_name>/<package_name>.activity`  

Services - tasks that run in the background  
e.g.  
`am startservice -n <package_name>/package_name.service`  

Broadcast Receiver - operating system notifications   
e.g.  
`am broadcast -a android.intent.action.BOOT_COMPLETED`  

Content Provider - share information with other applications  
e.g.  
`content query --uri content://sms/sent`  

### Proccess of Compiling
JVM - Java Virtual Machine 
.java -> javac(compiler)-> .class (bytecode)  

DVM - Dalvik Virtual Machine   
.java -> javac(compiler) -> .class(bytecode) -> dx(compiler) -> .dex(bytecode)  

ART - Android Runtime  
.java -> javac(compiler) -> .class(bytecode) -> dx(compiler) -> .dex(bytecode) -> dex2oat > native binary  

#### Structure of an apk
AndroidManifest.xml - package name, permissions, components  
META-INF - app metadata  
classes.dex - binary dalvik byte code - contains the current application code  
res - resources used by the app  
resources.arsc -  android app resource file  

### Basics
#### Android Debug Bridge  
-> Connect ADB  
`adb connect ip:5037`  
`adb shell`  

#### Extract apk / Install apk
-> Access https://play.google.com/store/search?q=<name_app>&c=apps and get package name or url  
https://apkgk.com/APK-Downloader  
https://apps.evozi.com/apk-downloader/  
https://m.apkpure.com/br/  
https://auroraoss.com/  
or  
`adb shell pm list packages -3 (third party package)`  
`adb shell pm path <package_name>`  
`adb pull <package_path>`  

## Reverse Engineering
### apk - .dex -> smali code(Assembler for Android)
-> baksmali - .dex -> smali code  
`java -jar baksmali.jar d <app.apk>`  
-> apktool decompiling - .dex (Dalvik executable files) -> smali  
`apktool d <app.apk>`  
-> recompile  
`apktool b <app.apk>`  
https://github.com/iBotPeaches/Apktool  
-> Doc - smali  
https://github.com/JesusFreke/smali/wiki/TypesMethodsAndFields  

### .dex -> Java .class
-> jadx  
https://github.com/skylot/jadx  
-> dex2jar & JD_GUI  
https://github.com/pxb1988/dex2jar  
https://github.com/java-decompiler/jd-gui  

Ps:  
Modify the app = smali code with apktool  
Understand the app logic = Java .class with dex2jar& jd_gui or jadx  

## Client Side Protections 
-> Obfuscation  
-> Root Detection  
-> SSL Pinning  
-> Detecting debuggers  
-> End to end encryption  

### Root Detection
Discovery for:  
-> Objection  
-> Static Analysis  

#### Root Detection Bypass 
`objection --gadget <package_name> explore`  
`android hooking list classes` or frida script listing_classes.js  
`android hooking list class_methods <package_name>` or frida script listing_methods.js  
`objection --gadget <package_name> explore -s "android hooking set return_value <package_name>.<class>.<method> false"`  
or  
Frida + Objection  
1-  
`frida -U -f <package_name>`  
2-  
`objection --gadget <package_name> explore -s "android hooking set return_value <package_name>.<class>.<method> false"`  
3-  
`%resume` in frida  

or write a frida script   

bypass_root_detection.js  
```
'use strict'

if(Java.available){
    Java.perform(function(){
        try{
            var target = Java.use("<package_name>.<class_name>");
            target.isDeviceRooted.implementation = function() {
            return false;
            };
        }catch(error){
            console.log("[-] An exception occured");
            console.log(String(error.stack));
        }
    });
}else{
    console.log("[-] Java unavailable");
}
```
`frida -U -f <package_name> -l bypass_root_detection.js`

### SSL Pinning Bypass
#### Install and preparation
-> Frida  
`pip install frida-tools`  
and/or not  
`pip install frida==15.0.7`  
`frida --version`  
-> frida-server  
https://github.com/frida/frida/releases/  
`adb push frida-server /data/local/tmp/frida-server`  
`adb shell chmod 755 /data/local/tmp/frida-server`  
`adb shell /data/local/tmp/frida-server &`  
-> Certificate Burp Suite  
`adb push cacert.cer /sdcard/Download/`  
-> Configure proxy in settings on mobile  
-> redirect 100% HTTP and HTTP traffic to tunnel ADB  
```
iptables -t nat -A OUTPUT -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8080  
iptables -t nat -A OUTPUT -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 8080  
```
`adb reverse tcp:8080 tcp:8080`  
`frida -U -f com.app.okay -l frida_multiple_unpinning.js --no-pause`

-> Install Objection  
`pip install objection`  

#### Bypassing NetworkSecurityConfig  Android >=7 & targetSdkVersion >= 24 only system certificates are trusted
-> decompiling  
`apktool d app.apk`  
cat AndroidManifest.xml  
`android:networkSecurityConfig="xml/network_security_config"`  
`vim /res/xml/network_security_config.xml`  
-> add in network_security_config.xml:  
`<certificates src="user" />`  
-> recompiling   
`apktool b app`  

"The APK Failed to install.  
Error: Could not parse error string."  

-> Sign the app  
Creating a Keystore  
`keytool -genkey -v -keystore mysigning.keystore -alias <app_alias> -keyalg RSA -keysize 2048 --validity 10000`  
Using the created keystore and sign the apk  
`jarsigner --verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore mysigning.keystore <app.apk> <app_alias>`  

### Objection - patchapk  
-> Decompile the apk file, modify the code to add the frida gadget, repackage the modified code and sign it  
`objection patchapk -s <app.apk>`  
or  
cat /proc/version  
cat /proc/cpuinfo   
-> Patch an apk with the frida-gadget.so   
`objection patchapk -s <app.apk> -a arm64-v8a`  
and  
`objection --gadget <package_name> explore -s 'android sslpinning disable'`

### End-to-End Encryption Bypass

Understand how the application is encrypting the data and decrypting it to obtain their encryption keys and tamper with the decrypted data
If end-to-end encryption is used, even if we have done the certificate installation, bypass SSL pinning and managed to intercept the traffic using a proxy(burp), we will not be able to see the plaintext traffic. This is custom encryption that is built in by the developer. that the application contains on top of SSL.
That means we will also have SSL along with that. 
-> Static analysis
-> Perform at runtime tracing 
Case:  
-> AES 256 being used for encrypt/decrypt data  
-> Client and server with the same encryption key  

`objection --gadget explore -s "android hooking watch class <package_name>.<AESclass> --dump-args --dump-return`  
endtoend.js
```
'use strict'
if(Java.available){
    Java.perform(function(){
        try{
            var aes_class = Java.use("<package_name>.<class_name>");
            aes_class.<method_name>.overload("[B").implementation = function (gk) {
                var key_value = this.bytesToHex(gk);
                console.log(returnvalue);
                return key_value;
            };
        }catch(error){
            console.log("[-] Exception");
            console.log(String(error.stack));
        }
    });
}else{
    console.log("[-] Java unavailable");
}
```
`frida -U -f <package_name> -l bypass_root_decetion.js -l endtoend.js`
There are more complex cases in which asymmetric cryptography will also be used to transfer the key and data.  
## Crack android pattern lock
```
adb shell
cd /data/data/com.android.providers.settings/databases
sqlite3 settings.db
update system set value=0 where name='lock_pattern_autolock';
update system set value=0 where name='lockscreen.lockedoutpermanently';
.quit
```
```
adb shell rm /data/system/gesture.key
```

### Vulnerabilities
#### Access Control (Exploitation Activity)
```
<activity android:label="@string/apic_label" android:name="<package_name>.APIKeyActivity">
  <intent-filter>
      <action android:name="<package_name>.action.VIEW_KEY" />
      <category android:name="android.intent-category.DEFAULT" />
  </intent-filter>
</activity>
```
e.g.:  
`adb shell am start <package_name>/.APIKeyActivity`  
or  
`adb shell am start <package_name>/.APIKeyActivity -a <package_name>.action.VIEW_KEY`  
e.g.:  
-> Variable validation case in boolean  
if (getIntent().getBooleanExtra(getString(R.string.vld_pin), false)) {  
`cat /res/values/strings.xml | grep vld_pin`  
`<string name="vld_pin">validate_pin</string>`  
`adb shell am start -n <package_name>/.APIKeyActivity -a <package_name>.action.VIEW_KEY --ez validate_pin true`  

#### Access Control (Content Provider)
```
<provider android:name="<package_name>.MessagesProvider" android:enabled="true" android:exported="true" android:authorities="<package_name>.provider.messagesprovider" />
```
`grep -R "content://" *`  
MessagesProvider.smali:  const-string v0, "content://<package_name>.provider.messagesprovider/messages"  
`adb shell content query --uri content://<package_name>.provider.messagesprovider/messages`  

### Insecure data storage
-> Android
#### Insecure data storage - SQLite Databases 
```
sqlite3 data/data/<package_name>/databases/ok.db  
.tables  
select * from <table>  
```
or  
`objection --gadget <package_name> explore`  
`env`  
`cd <path>`  
`sqlite connect ok.db` 
#### Insecure Data Storage - Shared Preferences 
`ls -la /data/data/<package_name>/shared_prefs/`  
#### Insecure Data Storage - Internal  
`/data/data/<package_name>/* or ?`  
#### Insecure Data Storage - External  
```ls -la /mnt/sdcard/```  

### Dump information about an object file - Lib  
-> /data/data/package/lib  
`objdump -s lib.so (.rodata - read only data, constants)`

### Android Debug Mode  
-> DEBUG mode is ON(andoid:debuggable="true") in AndroidManifest.xml

### Writing others scripts in Frida
listing_classes.js
```
'use strict'
if(Java.available){
  // Java.perform(function(){
        try{
            Java.enumerateLoadedClasses({
                onMatch: function(className){
                    console.log(className);
                },
                onComplete: function(){
                    console.log("[+] done!");
                }
            });
        }catch(error){
            console.log(error);
        }
 //   });
}else{
    console.log("[-] Java unavailable");
}
```
listing_methods.js
```
'use strict'
if(Java.available){
    Java.perform(function(){
        try{
            var target = Java.use("android.webkit.WebView");
            target.overload("java.lang.String").implementation = function (webview) {
                console.log("[+] " + webview.toString());
                return a;
            };
        }catch(error){
            console.log("[-] Exception");
            console.log(String(error.stack));
        }
    });
}else{
    console.log("[-] Java unavailable");
}
```

-> Doc
https://frida.re/docs/javascript-api/#objc-registerclass

### Automated Tools
#### Mobile Security Framework (MobSF)
https://github.com/MobSF/Mobile-Security-Framework-MobSF  
https://mobsf.live/  
#### Quick Android Review Kit
https://github.com/linkedin/qark  

### Others
"This application provides display and control of Android devices connected via USB or over TCP/IP. It does not require any root access. It works on GNU/Linux, Windows and macOS."  
https://github.com/Genymobile/scrcpy  

## Pentest in IOS application
IOS apps developed using Xcode(IDE) in Objective-C & Swift  
Apps' filename have the file extension .ipa  

### JailBreak
"Jailbreak for iPhone 5s through iPhone X, iOS 12.0 and up"  
https://checkra.in/  

### Cconfigure and preparation  
-> Install Frida and Objection  
https://github.com/sensepost/objection  
https://github.com/frida/frida  
`pip install frida-tools objection`  
-> Install SSH Server using Cydia on your device  
-> Install frida-server for ARM on your device  
frida - apt URL  
https://build.frida.re  

### Decrypting iOS Applications downloaded from App Store
"Apps downloaded from app store are encrypted."  
-> frida-ios-dump  
`edit ssh information in dump.py`
`python3 dump.py "<package_name"`
https://github.com/AloneMonkey/frida-ios-dump  

### Signing and Installing a Third-Party Application
-> Get signing identity  
`applesign -L`
-> Signing app .ipa  
`applesign -i <signing_identity> <app.ipa> -m embedded.mobileprovision`

### Dumping Class information
-> Extract the .ipa binary file  
`./class-dump <app_name>`  

### Extractor .ipa
`install ipainstaller console from cydia`  
`copy the *.ipa to the location you're running in terminal`  
`painstaller <app.ipa>`  

### frida-trace
`frida-trace -U -m "*[NSURLRequest *]" -n <app>

### Jailbreak Detection Bypass 
-> Objection  
`objection --gadget "<name>" explore -s "ios jailbreak disable"`

### Insecure Data Storage  
-> Plist files, NSUserDefaults, SQLite Databases, Core Data  
`cd /var/mobile/Containers/Data/Application/`  
`find -type d -name <app_name>` or using objection` 

### Issue - Untrusted Developer
General-> Profile & Device Management -> Developer App -> Trust "Apple Development ..." -> Trust

-> Keychain
https://github.com/ptoomey3/Keychain-Dumper  
-> Using sftp  
`./keychain-dumper > keychain.txt`  
Bruteforce required in passcode
