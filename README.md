# Tricks in Pentest Mobile (Android and IOS)

---
## Android Application Basics - Initial Topics

- [Android Application Basics (architecture, extract and install apk)](android_basics.md)

- [Reverse Engineering Android](reverse_engineering_android.md)

## Client-Side Protections Bypass - Android
![Root Detection (2)](https://user-images.githubusercontent.com/54555784/224454048-a07c12a5-4333-4272-838f-2f3fad21b0db.png)

### Root Detection Bypass
Discovery for:  
-> Objection  
-> Static Analysis  

-> Exploitation  
`objection --gadget <package_name> explore`  
`android hooking list classes` or frida script listing_classes.js  
`android hooking list class_methods <package_name>.<class_name>` or frida script listing_methods.js  
`objection --gadget <package_name> explore -s "android hooking set return_value <package_name>.<class_name>.<method_name> false"`  
or  
Frida + Objection  
1-  
`frida -U -f <package_name>`  
2-  
`objection --gadget <package_name> explore -s "android hooking set return_value <package_name>.<class>.<method> false"`  
3-  
`%resume` in frida  

or write a frida script   

bypass_root_detection.js  
```
'use strict'

if(Java.available){
    Java.perform(function(){
        try{
            var target = Java.use("<package_name>.<class_name>");
            target.isDeviceRooted.implementation = function() {
            return false;
            };
        }catch(error){
            console.log("[-] An exception occured");
            console.log(String(error.stack));
        }
    });
}else{
    console.log("[-] Java unavailable");
}
```
```
frida -U -f <package_name> -l bypass_root_detection.js
```

### SSL Pinning Bypass
-> Frida  
-> Objection  
-> Reverse engineering with apktool and Replacing Hard-Coded Certificate, Sha 256 Hash, etc

#### Install and preparation
-> Frida  
```
pip install frida-tools
```
and/or not  
```
pip install frida==15.0.7
frida --version
```
-> frida-server  
https://github.com/frida/frida/releases/  
```
adb push frida-server /data/local/tmp/frida-server
``` 

```
adb shell chmod 755 /data/local/tmp/frida-server
```
```
adb shell /data/local/tmp/frida-server &
```
-> Install Objection  
```
pip install objection
```

-> Certificate Burp Suite  
```
adb push cacert.cer /sdcard/Download/
```  
-> Configure proxy in settings on mobile  
or  
```
adb shell settings put global http_proxy <ip>:<port>
```
-> redirect 100% HTTP and HTTP traffic to tunnel ADB  
```
iptables -t nat -A OUTPUT -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8080  
iptables -t nat -A OUTPUT -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 8080  
```
```
adb reverse tcp:8080 tcp:8080
```

#### Patching apk - Objection (Android non rooted)
-> Decompile the apk file, modify the code to add the frida gadget, repackage the modified code and sign it  
```
objection patchapk -s <app.apk>
```
or  
```
cat /proc/version
cat /proc/cpuinfo
```
-> Patch an apk with the frida-gadget.so   
```
objection patchapk -s <app.apk> -a arm64-v8a
``` 

#### SSL Pinning Bypass with Frida
```
frida -U -f com.app.okay -l frida_multiple_unpinning.js --no-pause
``` 
![image](https://user-images.githubusercontent.com/54555784/224217100-34bd9d69-6386-4fe6-85fe-6f1cd7ce76bb.png)
https://codeshare.frida.re/@akabe1/frida-multiple-unpinning/%20%E2%80%8B

#### SSL Pinning Bypass with Objection
```
objection --gadget <package_name> explore -s 'android sslpinning disable'
```

#### Bypassing NetworkSecurityConfig  Android >=7 & targetSdkVersion >= 24 only system certificates are trusted
-> decompiling  
`apktool d app.apk`  
cat AndroidManifest.xml  
`android:networkSecurityConfig="xml/network_security_config"`  
`vim /res/xml/network_security_config.xml`  
-> add in network_security_config.xml:  
`<certificates src="user" />`  
-> recompiling   
`apktool b app`  

"The APK Failed to install.  
Error: Could not parse error string."  

-> Sign the app  
Creating a Keystore  
```
keytool -genkey -v -keystore mysigning.keystore -alias <app_alias> -keyalg RSA -keysize 2048 --validity 10000
```
Using the created keystore and sign the apk  
```
jarsigner --verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore mysigning.keystore <app.apk> <app_alias>
```

### End-to-End Encryption Bypass
![image](https://user-images.githubusercontent.com/54555784/224218113-3713d900-7619-4388-8ed3-b85b092909a6.png)

It is responsible for preventing the visualization of parameters in the request in clear text, 
Data sent is encrypted before leaving the device and can only be decrypted by the server.

Understand how the application is encrypting the data and decrypting it to obtain their encryption keys and tamper with the decrypted data.  
If end-to-end encryption is used, even if the certificate is installed, and bypassing the SSL pinning, and managing to intercept the traffic using a proxy (burp), we will not be able to see clear text data during the interception of HTTP /HTTPS traffic , end-to-end encryption prevents request tampering.

-> Static analysis  
-> Perform at runtime tracing  
Case:  
-> AES 256 being used for encrypt/decrypt data  
-> Client and server with the same encryption key  

```
objection --gadget explore -s "android hooking watch class <package_name>.<AESclass> --dump-args --dump-return
```

endtoend.js
```
'use strict'
if(Java.available){
    Java.perform(function(){
        try{
            var aes_class = Java.use("<package_name>.<class_name>");
            aes_class.<method_name>.overload("[B").implementation = function (gk) {
                var key_value = this.bytesToHex(gk);
                console.log(returnvalue);
                return key_value;
            };
        }catch(error){
            console.log("[-] Exception");
            console.log(String(error.stack));
        }
    });
}else{
    console.log("[-] Java unavailable");
}
```
`frida -U -f <package_name> -l bypass_root_decetion.js -l endtoend.js`  

There are more complex cases in which asymmetric cryptography will also be used to transfer the key and data.  

### Anti-Debugging
Debuggers can be useful for our analysis of the application, in order to increase our attack surface during a Pentest.  
An anti-debug mechanism will block our debugging.   
-> script anti-frida-bypass  
https://codeshare.frida.re/@meerkati/universal-android-debugging-bypass/

## Crack android pattern lock - Android
```
adb shell
cd /data/data/com.android.providers.settings/databases
sqlite3 settings.db
update system set value=0 where name='lock_pattern_autolock';
update system set value=0 where name='lockscreen.lockedoutpermanently';
.quit
```
```
adb shell rm /data/system/gesture.key
```

## Access Control - Android
### Activity Exploitation
```
<activity android:label="@string/apic_label" android:name="<package_name>.APIKeyActivity">
  <intent-filter>
      <action android:name="<package_name>.action.VIEW_KEY" />
      <category android:name="android.intent-category.DEFAULT" />
  </intent-filter>
</activity>
```
e.g.:  
`adb shell am start <package_name>/.APIKeyActivity`  
or  
`adb shell am start <package_name>/.APIKeyActivity -a <package_name>.action.VIEW_KEY`  
e.g.:  
-> Variable validation case in boolean  
if (getIntent().getBooleanExtra(getString(R.string.vld_pin), false)) {  
`cat /res/values/strings.xml | grep vld_pin`  
`<string name="vld_pin">validate_pin</string>`  
`adb shell am start -n <package_name>/.APIKeyActivity -a <package_name>.action.VIEW_KEY --ez validate_pin true`  

### Content Provider Exploitation 
```
<provider android:name="<package_name>.MessagesProvider" android:enabled="true" android:exported="true" android:authorities="<package_name>.provider.messagesprovider" />
```
`grep -R "content://" *`  
MessagesProvider.smali:  const-string v0, "content://<package_name>.provider.messagesprovider/messages"  
`adb shell content query --uri content://<package_name>.provider.messagesprovider/messages`  

## Insecure Data Storage on Android
### SQLite Databases 
```
sqlite3 data/data/<package_name>/databases/ok.db  
.tables  
select * from <table>  
```
or  
`objection --gadget <package_name> explore`  
`env`  
`cd <path>`  
`sqlite connect ok.db` 

### Shared Preferences 
`ls -la /data/data/<package_name>/shared_prefs/`  

### Internal  
`/data/data/<package_name>/* or ?`  

### External  
`ls -la /mnt/sdcard/`  

## Android Debug Mode  
-> DEBUG mode is ON(andoid:debuggable="true") in AndroidManifest.xml

## Dump information about an object file - Lib  
-> /data/data/package/lib  
`objdump -s lib.so (.rodata - read only data, constants)`

## Writing others scripts in Frida - Android
listing_classes.js
```
'use strict'
if(Java.available){
  // Java.perform(function(){
        try{
            Java.enumerateLoadedClasses({
                onMatch: function(className){
                    console.log(className);
                },
                onComplete: function(){
                    console.log("[+] done!");
                }
            });
        }catch(error){
            console.log(error);
        }
 //   });
}else{
    console.log("[-] Java unavailable");
}
```
listing_methods.js
```
'use strict'
if(Java.available){
    Java.perform(function(){
        try{
            var target = Java.use("android.webkit.WebView");
            target.overload("java.lang.String").implementation = function (webview) {
                console.log("[+] " + webview.toString());
                return a;
            };
        }catch(error){
            console.log("[-] Exception");
            console.log(String(error.stack));
        }
    });
}else{
    console.log("[-] Java unavailable");
}
```
-> Doc  
https://frida.re/docs/javascript-api/#objc-registerclass

## Automated Tools
### Mobile Security Framework (MobSF)
https://github.com/MobSF/Mobile-Security-Framework-MobSF  
https://mobsf.live/  

### Quick Android Review Kit
https://github.com/linkedin/qark  

### pithus - Mobile threat intelligence for the masses
https://beta.pithus.org/

### Others
"This application provides display and control of Android devices connected via USB or over TCP/IP. It does not require any root access. It works on GNU/Linux, Windows and macOS."  
https://github.com/Genymobile/scrcpy  

---

# IOS - Initial Topics 
- [Application IOS Basics(architecture, extract and install ipa](ios_basics.md)

## Client-Side Protections - IOS
![Root Detection (3)](https://user-images.githubusercontent.com/54555784/224454098-173f16dc-f28d-4cf3-8b45-f3e5ed6b2a04.png)

### Jailbreak Detection Bypass 
-> Objection  
```
objection --gadget "<name>" explore -s "ios jailbreak disable"
```
-> Static Analysis with Hopper (Disassembler)  
https://developer.arm.com/documentation/dui0802/a/A64-General-Instructions/TBZ
https://developer.arm.com/documentation/dui0802/b/A64-General-Instructions/TBNZ
https://developer.arm.com/documentation/dui0802/b/A64-General-Instructions/

### SSL Pinning Bypass
-> Frida
-> Objection
-> SSL Kill Switch 2
-> Bypass via Replacing Hard-Coded Certificate
-> Bypass via Replacing Hard-Coded Sha 256 Hash
-> SSL Pinning Bypass with Hopper  

#### Configure Proxy
1. Install certificate burp  
2. Activating trust in the installed certificate -> Settings > General > About > Certificate Trust Settings  
3. Install Mobile assistant -> Add http://<burp_ip>:<burp_port> in Cydia/APT URL  

####  SSL Pinning Bypass with Frida
```
frida -U -f <package_name> -l ssl.js --no-pause
```

#### SSL Pinning Bypass with Objection
1- Add https://build.frida.re in Cydia/APT URL Cydia -> install frida  
```
objection --gadget <package_name> explore -s ios sslpinning disable
```

#### Bypass via Replacing Hard-Coded Certificate
```
unzip .ipa
find . | grep .cer
cp ~/Path_of_Your_burp_certificate  ./Full_Path_Of_Hardcoded_Certificate
```  
1. Zip the Payload folder
2. Rename the zip to .IPA  
3. Install the app via Cydia impactor  

#### SSL Kill Switch 2
1- Install “SSLKillSwitch” on Cydia 2- Settings -> SSL Kill Switch Application -> Disable Certificate Validation

#### Bypass via Replacing Hard-Coded Sha256
Generate your burp suite certificate hash via the following command 
```
unzip .IPA
openssl x509 -inform DER -in cacert.cer -out cacert.crt
openssl x509 -in cacert.crt -pubkey -noout | openssl pkey -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64
```
Replace our hash value with application hash via any editor.  
1. Zip the Payload folder  
2. Rename the zip to .IPA  
3. Install the app via Cydia impactor  

### End-to-end Encryption
![image](https://user-images.githubusercontent.com/54555784/224218113-3713d900-7619-4388-8ed3-b85b092909a6.png)

Understand how the application is encrypting the data and decrypting it to obtain their encryption keys and tamper with the decrypted data.  
If end-to-end encryption is used, even if we have done the certificate installation, bypass SSL pinning and managed to intercept the traffic using a proxy(burp), we will not be able to see the plaintext traffic. This is custom encryption that is built in by the developer. that the application contains on top of SSL.
That means we will also have SSL along with that.  
-> Static analysis  
-> Perform at runtime tracing  
Case:  
-> AES 256 being used for encrypt/decrypt data  
-> Client and server with the same encryption key  

#### Getting crypto Key - end-to-end
-> Tracing crypto calls and dealing with end-to-end encryption  
```
frida-trace -U -m "*[NSURLRequest *]" -n <app_name>
```  
-> Duming crypto keys - Objection  
e.g.  
```
ios hooking watch method "-[NSData <method>:error:]" --dump-args --dump-return --dump-backtrace
```

## Dumping Class information - IOS (Requires MacOS)
-> Extract binary file of .ipa  
```
./class-dump <app_name>
```
http://stevenygard.com/projects/class-dump/

## Insecure Data Storage - IOS
### Plist files, NSUserDefaults, SQLite Databases, Core Data  
`find -type d -name <app_name>` or using objection  
`cd /var/mobile/Containers/Data/Application/`  

### Keychain  
https://github.com/ptoomey3/Keychain-Dumper  
`./keychain-dumper > keychain.txt`  
Bruteforce required in passcode
    
## Issue IOS - Untrusted Developer
General -> Profile & Device Management -> Developer App -> Trust "Apple Development ..." -> Trust  

## IOS Memory Dump
-> Objection  
```
memory dump all <name.dmp>
```
---
## Bonus

### Anti-Frida
The anti-frida performs the blockade by detecting:  
-Changes of Instructions;  
-Door used by frida;  
- Named pipes and threads used by Frida;  
- Comparison of the text section in memory with the text section in disk for libc and native library.  

Keep in mind that you need to analyze the code to find out how to better bypass the anti-frida used by the app.  

-> script anti-frida-bypass  
https://codeshare.frida.re/@enovella/anti-frida-bypass/

### TLS Pinning vs mTLS Pinning 
When pinning a certificate using TLS Pinning, the application is forced to validate the server certificate, while in mTLS mTLS double validation takes place, both of the client certificate and of the server.

### TLS Pinning
<img height=250 src="https://user-images.githubusercontent.com/54555784/224217453-43e07e12-e909-439b-929f-f87983bcb4ce.png" />

#### mTLS Pinning
<img height=295 src="https://user-images.githubusercontent.com/54555784/224217429-997f149a-d523-4a57-9b3b-86c272b94ba7.png" />

- Do not store client secrets and certificates directly in the application package;  
- Use password manager, such as keystore for android devices and keychain for IOS.  

Reference:
https://www.cloudflare.com/pt-br/learning/access-management/what-is-mutual-tls/
