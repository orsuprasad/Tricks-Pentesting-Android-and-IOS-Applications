# Tricks in Pentest Mobile (Android and IOS)

---

## Android applications
### Architecture
<a href="https://developer.android.com/static/guide/platform/images/android-stack_2x.png">
    <img  height="650em" src="https://developer.android.com/static/guide/platform/images/android-stack_2x.png" />
</a>

### Components
Activities - show screens to the user and allow them to interact with those screens  
e.g.  
`am start -n <package_name>/<package_name>.activity`  

-> Create malicious app and call activity:  
```
Intent intent = new Intent();
intent.setClassName("<package_name>", "<package_name>.<activity>");
startActivity(intent);
```
Services - tasks that run in the background  
e.g.  
`am startservice -n <package_name>/package_name.service`  

Broadcast Receiver - operating system notifications   
e.g.  
`am broadcast -a android.intent.action.BOOT_COMPLETED`  

Content Provider - share information with other applications  
e.g.  
`content query --uri content://sms/sent`  

Create malicious app and call content provider:
```
Uri uri = Uri.parse("content://com.example.myapplication/ok.txt");
ContentResolver cr = getContentResolver();
Cursor c = cr.query(uri, cols, null, null, null);
```

### Proccess of Compiling
JVM - Java Virtual Machine  
.java -> javac(compiler)-> .class (bytecode)  

DVM - Dalvik Virtual Machine   
.java -> javac(compiler) -> .class(bytecode) -> dx(compiler) -> .dex(bytecode)  

ART - Android Runtime  
.java -> javac(compiler) -> .class(bytecode) -> dx(compiler) -> .dex(bytecode) -> dex2oat > native binary  

### Structure of an apk
AndroidManifest.xml - package name, permissions, components  
META-INF - app metadata  
classes.dex - binary dalvik byte code, contains the current application code  
res - resources used by the app  
resources.arsc -  android app resource file  

## Android Basics
### Debug Bridge  
-> Connect ADB  
`adb connect ip:5037`  
`adb shell`  

### Extract apk / Install apk
-> Access https://play.google.com/store/search?q=<name_app>&c=apps and get package name or url  
https://apkgk.com/APK-Downloader  
https://apps.evozi.com/apk-downloader/  
https://m.apkpure.com/br/  
https://auroraoss.com/  
or  
`adb shell pm list packages -3 (list third party package)`  
`adb shell pm path <package_name> (Print the path to the .apk) `  
`adb pull <package_path> (get files from device)`  
`adb install example.apk (install apk on device)`
-> Others  
https://adbshell.com/commands/adb-shell-pm-path

## Reverse Engineering on Android
### apk - .dex (Dalvik executable files) -> smali code (Assembler for Android)
-> baksmali ( .dex -> smali code )  
`java -jar baksmali.jar d <app.apk>`  
-> apktool decompiling ( .dex -> smali code)  
`apktool d <app.apk>`  
-> recompile  
`apktool b <app.apk>`  
https://github.com/iBotPeaches/Apktool  
-> Doc - smali  
https://github.com/JesusFreke/smali/wiki/TypesMethodsAndFields  

### .dex -> Java .class
-> jadx  
https://github.com/skylot/jadx  
-> dex2jar & JD_GUI  
https://github.com/pxb1988/dex2jar  
https://github.com/java-decompiler/jd-gui  

Ps:  
Modify the app = smali code with apktool  
Understand the app logic = Java .class with dex2jar& jd_gui or jadx  

## Client-Side Protections - Android
-> Obfuscation  
-> Emulation Detection  
-> Root Detection  
-> SSL Pinning  
-> Detecting debuggers  
-> End-to-end encryption  

### Root Detection Bypass
Discovery for:  
-> Objection  
-> Static Analysis  

-> Exploitation  
`objection --gadget <package_name> explore`  
`android hooking list classes` or frida script listing_classes.js  
`android hooking list class_methods <package_name>` or frida script listing_methods.js  
`objection --gadget <package_name> explore -s "android hooking set return_value <package_name>.<class>.<method> false"`  
or  
Frida + Objection  
1-  
`frida -U -f <package_name>`  
2-  
`objection --gadget <package_name> explore -s "android hooking set return_value <package_name>.<class>.<method> false"`  
3-  
`%resume` in frida  

or write a frida script   

bypass_root_detection.js  
```
'use strict'

if(Java.available){
    Java.perform(function(){
        try{
            var target = Java.use("<package_name>.<class_name>");
            target.isDeviceRooted.implementation = function() {
            return false;
            };
        }catch(error){
            console.log("[-] An exception occured");
            console.log(String(error.stack));
        }
    });
}else{
    console.log("[-] Java unavailable");
}
```
`frida -U -f <package_name> -l bypass_root_detection.js`

### SSL Pinning Bypass
-> Frida  
-> Objection  
-> Reverse engineering with apktool and Replacing Hard-Coded Certificate, Sha 256 Hash, etc

#### Install and preparation
-> Frida  
`pip install frida-tools`  
and/or not  
`pip install frida==15.0.7`  
`frida --version`  
-> frida-server  
https://github.com/frida/frida/releases/  
`adb push frida-server /data/local/tmp/frida-server`  
`adb shell chmod 755 /data/local/tmp/frida-server`  
`adb shell /data/local/tmp/frida-server &`  
-> Install Objection  
`pip install objection`  

-> Certificate Burp Suite  
`adb push cacert.cer /sdcard/Download/`  
-> Configure proxy in settings on mobile  
or  
```
adb shell settings put global http_proxy <ip>:<port>
```
-> redirect 100% HTTP and HTTP traffic to tunnel ADB  
```
iptables -t nat -A OUTPUT -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8080  
iptables -t nat -A OUTPUT -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 8080  
```
`adb reverse tcp:8080 tcp:8080`  

#### Patching apk - Objection (Android non rooted)
-> Decompile the apk file, modify the code to add the frida gadget, repackage the modified code and sign it  
`objection patchapk -s <app.apk>`  
or  
`cat /proc/version`  
`cat /proc/cpuinfo`  
-> Patch an apk with the frida-gadget.so   
`objection patchapk -s <app.apk> -a arm64-v8a`  

#### SSL Pinning Bypass with Frida
`frida -U -f com.app.okay -l frida_multiple_unpinning.js --no-pause`  

#### SSL Pinning Bypass with Objection
`objection --gadget <package_name> explore -s 'android sslpinning disable'`

#### Bypassing NetworkSecurityConfig  Android >=7 & targetSdkVersion >= 24 only system certificates are trusted
-> decompiling  
`apktool d app.apk`  
cat AndroidManifest.xml  
`android:networkSecurityConfig="xml/network_security_config"`  
`vim /res/xml/network_security_config.xml`  
-> add in network_security_config.xml:  
`<certificates src="user" />`  
-> recompiling   
`apktool b app`  

"The APK Failed to install.  
Error: Could not parse error string."  

-> Sign the app  
Creating a Keystore  
`keytool -genkey -v -keystore mysigning.keystore -alias <app_alias> -keyalg RSA -keysize 2048 --validity 10000`  
Using the created keystore and sign the apk  
`jarsigner --verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore mysigning.keystore <app.apk> <app_alias>`  

### End-to-End Encryption Bypass
Understand how the application is encrypting the data and decrypting it to obtain their encryption keys and tamper with the decrypted data
If end-to-end encryption is used, even if we have done the certificate installation, bypass SSL pinning and managed to intercept the traffic using a proxy(burp), we will not be able to see the plaintext traffic. This is custom encryption that is built in by the developer. that the application contains on top of SSL.
That means we will also have SSL along with that.  
-> Static analysis  
-> Perform at runtime tracing 
Case:  
-> AES 256 being used for encrypt/decrypt data  
-> Client and server with the same encryption key  

`objection --gadget explore -s "android hooking watch class <package_name>.<AESclass> --dump-args --dump-return`  
endtoend.js
```
'use strict'
if(Java.available){
    Java.perform(function(){
        try{
            var aes_class = Java.use("<package_name>.<class_name>");
            aes_class.<method_name>.overload("[B").implementation = function (gk) {
                var key_value = this.bytesToHex(gk);
                console.log(returnvalue);
                return key_value;
            };
        }catch(error){
            console.log("[-] Exception");
            console.log(String(error.stack));
        }
    });
}else{
    console.log("[-] Java unavailable");
}
```
`frida -U -f <package_name> -l bypass_root_decetion.js -l endtoend.js`  

There are more complex cases in which asymmetric cryptography will also be used to transfer the key and data.  

## Crack android pattern lock - Android
```
adb shell
cd /data/data/com.android.providers.settings/databases
sqlite3 settings.db
update system set value=0 where name='lock_pattern_autolock';
update system set value=0 where name='lockscreen.lockedoutpermanently';
.quit
```
```
adb shell rm /data/system/gesture.key
```

## Access Control - Android
### Activity Exploitation
```
<activity android:label="@string/apic_label" android:name="<package_name>.APIKeyActivity">
  <intent-filter>
      <action android:name="<package_name>.action.VIEW_KEY" />
      <category android:name="android.intent-category.DEFAULT" />
  </intent-filter>
</activity>
```
e.g.:  
`adb shell am start <package_name>/.APIKeyActivity`  
or  
`adb shell am start <package_name>/.APIKeyActivity -a <package_name>.action.VIEW_KEY`  
e.g.:  
-> Variable validation case in boolean  
if (getIntent().getBooleanExtra(getString(R.string.vld_pin), false)) {  
`cat /res/values/strings.xml | grep vld_pin`  
`<string name="vld_pin">validate_pin</string>`  
`adb shell am start -n <package_name>/.APIKeyActivity -a <package_name>.action.VIEW_KEY --ez validate_pin true`  

### Content Provider Exploitation 
```
<provider android:name="<package_name>.MessagesProvider" android:enabled="true" android:exported="true" android:authorities="<package_name>.provider.messagesprovider" />
```
`grep -R "content://" *`  
MessagesProvider.smali:  const-string v0, "content://<package_name>.provider.messagesprovider/messages"  
`adb shell content query --uri content://<package_name>.provider.messagesprovider/messages`  

## Insecure Data Storage on Android
### SQLite Databases 
```
sqlite3 data/data/<package_name>/databases/ok.db  
.tables  
select * from <table>  
```
or  
`objection --gadget <package_name> explore`  
`env`  
`cd <path>`  
`sqlite connect ok.db` 
### Shared Preferences 
`ls -la /data/data/<package_name>/shared_prefs/`  
### Internal  
`/data/data/<package_name>/* or ?`  
### External  
`ls -la /mnt/sdcard/`  

## Android Debug Mode  
-> DEBUG mode is ON(andoid:debuggable="true") in AndroidManifest.xml

## Dump information about an object file - Lib  
-> /data/data/package/lib  
`objdump -s lib.so (.rodata - read only data, constants)`

## Writing others scripts in Frida - Android
listing_classes.js
```
'use strict'
if(Java.available){
  // Java.perform(function(){
        try{
            Java.enumerateLoadedClasses({
                onMatch: function(className){
                    console.log(className);
                },
                onComplete: function(){
                    console.log("[+] done!");
                }
            });
        }catch(error){
            console.log(error);
        }
 //   });
}else{
    console.log("[-] Java unavailable");
}
```
listing_methods.js
```
'use strict'
if(Java.available){
    Java.perform(function(){
        try{
            var target = Java.use("android.webkit.WebView");
            target.overload("java.lang.String").implementation = function (webview) {
                console.log("[+] " + webview.toString());
                return a;
            };
        }catch(error){
            console.log("[-] Exception");
            console.log(String(error.stack));
        }
    });
}else{
    console.log("[-] Java unavailable");
}
```
-> Doc  
https://frida.re/docs/javascript-api/#objc-registerclass

## Automated Tools
### Mobile Security Framework (MobSF)
https://github.com/MobSF/Mobile-Security-Framework-MobSF  
https://mobsf.live/  
### Quick Android Review Kit
https://github.com/linkedin/qark  
### pithus - Mobile threat intelligence for the masses
https://beta.pithus.org/

### Others
"This application provides display and control of Android devices connected via USB or over TCP/IP. It does not require any root access. It works on GNU/Linux, Windows and macOS."  
https://github.com/Genymobile/scrcpy  

---

## IOS applications
### Architecture
<a href="https://www.pcloudy.com/wp-content/uploads/2019/02/2.3.png"> 
    <img height="600em" src="https://www.pcloudy.com/wp-content/uploads/2019/02/2.3.png" /> 
</a>

IOS apps developed using Xcode(IDE) in Objective-C & Swift  
Applications file name has .ipa file extension

## Setup and Preparation
### JailBreak 
"Jailbreak for iPhone 5s through iPhone X, iOS 12.0 and up"  
https://checkra.in/  
-> Install Frida and Objection  
https://github.com/sensepost/objection  
https://github.com/frida/frida  
`pip install frida-tools objection`  
-> Install SSH Server using Cydia on your device  
-> Install frida-server for ARM on your device  
frida - apt URL:  
https://build.frida.re  

### Patching .ipa - Objection (non Jailbroken) - Require MacOS
-> Install applesign  
`npm install -g applesign`  
-> Install insert_dylib  
```
git clone https://github.com/Tyilo/insert_dylib
cd insert_dylib
xcodebuild
cp build/Release/insert_dylib /usr/local/bin/insert_dylib
```
-> Install xcode cli  
-> Install objection  
`pip install objection`  
-> Get signing identity  
`applesign -L`  
-> Patching .ipa  
`objection patchipa --source <app.ipa> --code-signature <identity_signature> -P embedded.mobileprovision`  
-> Deploy  
`git clone https://github.com/ios-control/ios-deploy`  
`ios-deploy ---bundle <app.apk> --debug -W`

## Decrypting iOS Applications downloaded from App Store
"Apps downloaded from app store are encrypted."  
-> frida-ios-dump  
edit ssh information in dump.py  
`python3 dump.py "<package_name>"`  
https://github.com/AloneMonkey/frida-ios-dump  

## Dumping Class information - IOS (Requires MacOS)
-> Extract binary file of .ipa  
`./class-dump <app_name>`  
http://stevenygard.com/projects/class-dump/

## Insecure Data Storage - IOS
### Plist files, NSUserDefaults, SQLite Databases, Core Data  
`find -type d -name <app_name>` or using objection  
`cd /var/mobile/Containers/Data/Application/`  
### Keychain  
https://github.com/ptoomey3/Keychain-Dumper  
`./keychain-dumper > keychain.txt`  
Bruteforce required in passcode
    
## Issue IOS - Untrusted Developer
General -> Profile & Device Management -> Developer App -> Trust "Apple Development ..." -> Trust  

## Signing and Installing a Third-Party IOS Application - Require MacOS
-> Get signing identity  
`applesign -L`  
-> Signing app .ipa  
`applesign -i <signing_identity> <app.ipa> -m embedded.mobileprovision`

## IOS Memory Dump
-> Objection  
`memory dump all <name.dmp>`

## Client-Side Protections - IOS
-> Obfuscation  
-> Jailbreak Detection  
-> SSL Pinning  
-> Detecting debuggers  
-> End to end encryption  

### Jailbreak Detection Bypass 
-> Objection  
`objection --gadget "<name>" explore -s "ios jailbreak disable"`
-> Static Analysis with Hopper (Disassembler)
https://developer.arm.com/documentation/dui0802/a/A64-General-Instructions/TBZ
https://developer.arm.com/documentation/dui0802/b/A64-General-Instructions/TBNZ
https://developer.arm.com/documentation/dui0802/b/A64-General-Instructions/

### SSL Pinning Bypass
-> Frida
-> Objection
-> SSL Kill Switch 2
-> Bypass via Replacing Hard-Coded Certificate
-> Bypass via Replacing Hard-Coded Sha 256 Hash
-> SSL Pinning Bypass with Hopper  

#### Configure Proxy
1. Install certificate burp  
2. Activating trust in the installed certificate -> Settings > General > About > Certificate Trust Settings  
3. Install Mobile assistant -> Add http://<burp_ip>:<burp_port> in Cydia/APT URL  

####  SSL Pinning Bypass with Frida
`frida -U -f <package_name> -l ssl.js --no-pause`

#### SSL Pinning Bypass with Objection
1- Add https://build.frida.re in Cydia/APT URL Cydia -> install frida  
`
objection --gadget <package_name> explore -s ios sslpinning disable
`

#### Bypass via Replacing Hard-Coded Certificate
```
unzip .ipa
find . | grep .cer
cp ~/Path_of_Your_burp_certificate  ./Full_Path_Of_Hardcoded_Certificate
```
1. Zip the Payload folder  
2- Rename the zip to .IPA  
3- Install the app via Cydia impactor  

#### SSL Kill Switch 2
1- Install “SSLKillSwitch” on Cydia 2- Settings -> SSL Kill Switch Application -> Disable Certificate Validation

#### Bypass via Replacing Hard-Coded Sha256
Generate your burp suite certificate hash via the following command 
```
unzip .IPA
openssl x509 -inform DER -in cacert.cer -out cacert.crt
openssl x509 -in cacert.crt -pubkey -noout | openssl pkey -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64
```
Replace our hash value with application hash via any editor.
1. Zip the Payload folder  
2- Rename the zip to .IPA  
3- Install the app via Cydia impactor  

### End-to-end
Understand how the application is encrypting the data and decrypting it to obtain their encryption keys and tamper with the decrypted data
If end-to-end encryption is used, even if we have done the certificate installation, bypass SSL pinning and managed to intercept the traffic using a proxy(burp), we will not be able to see the plaintext traffic. This is custom encryption that is built in by the developer. that the application contains on top of SSL.
That means we will also have SSL along with that.  
-> Static analysis  
-> Perform at runtime tracing  
Case:  
-> AES 256 being used for encrypt/decrypt data  
-> Client and server with the same encryption key  

#### Getting crypto Key - end-to-end
-> Tracing crypto calls and dealing with end-to-end encryption  
`frida-trace -U -m "*[NSURLRequest *]" -n <app_name>`  
-> Duming crypto keys - Objection  
e.g.  
`ios hooking watch method "-[NSData <method>:error:]" --dump-args --dump-return --dump-backtrace`
